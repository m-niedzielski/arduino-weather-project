<script>
async function connectToArduino() {
    if ('serial' in navigator) {
        try {
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            alert("Connected to Arduino!");

            const textDecoder = new TextDecoderStream();
            port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();

            let receivedData = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    console.log('Stream closed');
                    break;
                }

                if (value) {
                    receivedData += value;
                    console.log("Accumulated serial data:", receivedData);

                    // Check for newline, indicating a complete data line
                    if (receivedData.includes("\n")) {
                        const serialData = receivedData.trim();  // Trim any leading/trailing spaces
                        console.log("Complete serial data:", serialData);

                        // Reset the buffer before sending the data
                        receivedData = '';

                        // Check if the serialData is valid and contains the expected format
                        if (serialData && serialData.match(/^\d+\.\d{2},\d+\.\d{2},\d+\.\d{2}$/)) {
                            // Send the data to Google Apps Script
                            await fetch('https://script.google.com/macros/s/AKfycbzRSB4ANNVjYk33cymhu9Fp8AwQm5j6gTPTFAVBObYLc5G-62Z8kDe2EEi-OA2MdFeG/exec', {
                                method: 'POST',
                                body: serialData, 
                                headers: {
                                    'Content-Type': 'text/plain'
                                }
                            })
                            .then(response => response.text())
                            .then(result => {
                                console.log("Data sent successfully:", result);
                            })
                            .catch(error => {
                                console.error("Error sending data:", error);
                            });
                        } else {
                            console.error("Invalid data format:", serialData);
                        }
                    }
                }
            }
        } catch (err) {
            alert("Connection failed: " + err.message);
        }
    } else {
        alert("Web Serial API is not supported in this browser.");
    }
}
</script>
